<!DOCTYPE html>
<html>
  <head>
    <title>Chaos Game</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/mono.css" />
    <style>
      /* theme overrides */
      body {
        background-color: #2e2a31;
        color: #bcbabe;
      }

      input {
        color: #bcbabe;
      }

      h1 { font-weight: normal; }

      button {
        border-color: #bcbabe;
        color: #bcbabe;
        background-color: #342f38;
      }

      button:hover {
        color: #bcbabe;
        background-color: #3c3641;
      }

      button.active, button:active {
        background-color: #342f38;
        color: #796af5;
        border-color: #796af5;
      }

      .text-highlight {
        color: #f5f4f7 !important;
      }

      ::selection {
        color: #4a464d;
        background-color: #149bda;
      }
      ::-moz-selection {
        color: #4a464d;
        background-color: #149bda;
      }


      .inverse {
        color: #4a464d;
        background-color: #149bda;
      }

      .inverse a, .inverse a:visited {
        color: #4a464d;
      }

      .background-highlight {
        background-color: #4a464d;
      }

      a {
        color: #d8137f;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      a:visited {
        color: #bb60ea;
      }

      /* custom */
      #canvas {
        margin: auto;
        display: block;
        width: 700px;
        height: 700px;
      }

      input {
        flex: 1;
        max-width: 3em;
        text-align: right;
        margin: 5px;
        border: none;
        border-bottom: solid 2px rgba(188, 186, 190,.3);
        background-color: transparent;
      }

      select {
        font-size: 16px;
        font-family: Menlo, Consolas, monospace;
        padding: 0px 4px;
      }

      .hover-hide .visible-on-hover {
        visibility: hidden;
      }
      .hover-hide:hover .visible-on-hover {
        visibility: visible;
      }
    </style>

  </head>
  <body>
    <div class="align-right pam">
      <a href="/">
        goodrobot.net
      </a>
    </div>
    <div id="content" class="content">
      <h1>Chaos Game</h1>
      <p>
        The Chaos Game is another way to generate fractals. In a lot of ways it is similar to IFS
        fractals.
      </p>
      <div class="align-center">
        <ul class="list-inline pbm align-center">
          <li><button id="sierpinski">Sierpinski</button></li>
        </ul>
      </div>

      <canvas id="canvas" width="700" height="700"></canvas>

      <div class="flex-container row">
        <canvas style="display:none" id="ruleCanvas" width="200" height="200"></canvas>
        <div class="flex-1" id="ruleLegend"></div>
      </div>

      <div id="settings">
        <div>
          <label for="sides">Polygon Sides: </label>
          <input id="sides" v-model.number="sides" type="text" value="4">
        </div>
        <div>
          <label for="distance">Move Distance:</label>
          <input id="distance" v-model.number="distance" type="text" value="0.5">
        </div>
        <div v-if="rules && rules.length">
          The next point cannot be:
          <table>
            <tr class="hover-hide" v-for="(rule, index) in rules">
              <td class="hover-hide" v-for="pIdx in sides">
                <label><input type="checkbox" value="true" v-on:click="updateRule(index, pIdx - 1, $event)" v-model="rule[pIdx - 1]">{{ pIdx - 1 }}</label>
              </td>
              <td class="visible-on-hover"><button v-on:click="removeRule(index)">Remove</button></td>
            </tr>
          </table>
        </div>
        <div class="align-center" v-else>The next point will be randomly choosen</div>
        <div class="align-center">
          <td colspan="4"><button v-on:click="addRule">Add new rule</button></td>
        </div>
      </div>

    </div>
    <script src="../js/vendor/vue.min.js"></script>
    <script src="../js/canvas.js"></script>
    <script src="../js/runner.js"></script>
    <script src="../js/unikitty.js"></script>
    <script src="chaos.js"></script>
    <script>

      const ui = new Vue({
        el: '#settings',
        data: {
          sides: 5,
          distance: 0.5,
          rules: [
            {0: false, 1: true, 2: false, 3: false, 4: true},
            {0: false, 1: true, 2: false, 3: false, 4: true},
          ]
        },
        watch: {
          sides: function () {
            this.rules = this.rules.map(rule => {
              const r = {};
              for (var i = 0; i < this.sides; i += 1) {
                r[i] = !!rule[i];
              }
              return r;
            });
          },
          rules: {
            handler: function ruleHandler() {
              const rule = this.rules.map(r => {
                return Object.keys(r).reduce(
                  ((invalids, key) => {
                    if (r[key]) { invalids.push(parseInt(key, 10)); }
                   return invalids;
                  }),
                  []
                );
              });
              console.log('render', parseInt(this.sides, 10), rule, move(parseFloat(this.distance)));
              render(parseInt(this.sides, 10), rule, move(parseFloat(this.distance)));
            },
            deep: true
          }
        },
        methods: {
          updateRule: function (ruleIndex, point, event) {
            console.log(event.target.checked, this.rules[ruleIndex]);
            this.rules[ruleIndex][point] = event.target.checked;
          },
          addRule: function () {
            this.rules.push({ points: 0, previous: 1 });
          },
          removeRule: function (idx) {
            this.rules.splice(idx, 1);
          }
        }
      });
    </script>
  </body>
</html>
